generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  OWNER
  CASHIER
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  TRIAL
}

model Store {
  id           String         @id @default(cuid())
  name         String
  address      String?
  phone        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  users         User[]
  products      Product[]
  ingredients   Ingredient[]
  formulas      Formula[]
  transactions  Transaction[]
  customers     Customer[]
  suppliers     Supplier[]
  subscription  Subscription?

  @@index([name])
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(OWNER)
  storeId   String?
  isApproved Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store     Store?   @relation(fields: [storeId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([storeId])
}

model Subscription {
  id        String             @id @default(cuid())
  storeId   String             @unique
  status    SubscriptionStatus @default(TRIAL)
  planName  String             @default("Silver")
  startDate DateTime           @default(now())
  endDate   DateTime
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  store     Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
}

model Ingredient {
  id        String   @id @default(cuid())
  name      String
  unit      String
  stock     Float    @default(0)
  storeId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  formulas  FormulaItem[]

  @@index([storeId])
  @@index([name])
}

model Product {
  id          String   @id @default(cuid())
  name        String
  price       Decimal  @db.Decimal(12, 2)
  stock       Int      @default(0)
  isFormula   Boolean  @default(false)
  storeId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store            Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  formula          Formula?
  transactionItems TransactionItem[]

  @@index([storeId])
  @@index([name])
}

model Formula {
  id        String   @id @default(cuid())
  productId String   @unique
  storeId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product   Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  store     Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  items     FormulaItem[]

  @@index([productId])
  @@index([storeId])
}

model FormulaItem {
  id           String @id @default(cuid())
  formulaId    String
  ingredientId String
  quantity     Float
  
  formula      Formula    @relation(fields: [formulaId], references: [id], onDelete: Cascade)
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@index([formulaId])
  @@index([ingredientId])
}

model Transaction {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  totalAmount   Decimal  @db.Decimal(12, 2)
  cashierName   String
  storeId       String
  customerId    String?
  createdAt     DateTime @default(now())

  customer     Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull)
  store        Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  items        TransactionItem[]

  @@index([storeId])
  @@index([createdAt])
  @@index([customerId])
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  notes     String?
  storeId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store        Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([storeId])
  @@index([name])
}

model Supplier {
  id        String   @id @default(cuid())
  name      String
  contact   String?
  address   String?
  storeId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@index([name])
}

model TransactionItem {
  id            String  @id @default(cuid())
  transactionId String
  productId     String
  quantity      Int
  price         Decimal @db.Decimal(12, 2)
  subtotal      Decimal @db.Decimal(12, 2)

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  product     Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([productId])
}
